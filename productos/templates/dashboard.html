{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<section style="margin-bottom:28px;">
  <h2 style="margin:0 0 6px;font-size:30px;font-weight:800;color:#0b2e68;">Panel de control</h2>
  <p style="margin:0;color:#5b6578;font-size:14px;">Resumen ejecutivo del inventario y sus indicadores clave.</p>
</section>

<section style="display:flex;flex-wrap:wrap;gap:20px;margin-bottom:32px;">
  <article style="background:#0b6cff;color:#ffffff;padding:20px;border-radius:18px;flex:1;min-width:220px;">
    <h3 style="margin:0 0 6px;font-size:16px;font-weight:700;">Total de productos</h3>
    <p style="margin:0;font-size:32px;font-weight:800;">{{ total_productos }}</p>
  </article>
  <article style="background:#1f9d55;color:#ffffff;padding:20px;border-radius:18px;flex:1;min-width:220px;">
    <h3 style="margin:0 0 6px;font-size:16px;font-weight:700;">Con stock</h3>
    <p style="margin:0;font-size:32px;font-weight:800;">{{ productos_con_stock }}</p>
  </article>
  <article style="background:#dc3545;color:#ffffff;padding:20px;border-radius:18px;flex:1;min-width:220px;">
    <h3 style="margin:0 0 6px;font-size:16px;font-weight:700;">Sin stock</h3>
    <p style="margin:0;font-size:32px;font-weight:800;">{{ productos_sin_stock }}</p>
  </article>
  <article style="background:#f0ad4e;color:#1f2a44;padding:20px;border-radius:18px;flex:1;min-width:220px;">
    <h3 style="margin:0 0 6px;font-size:16px;font-weight:700;">En oferta</h3>
    <p style="margin:0;font-size:32px;font-weight:800;">{{ productos_en_oferta }}</p>
  </article>
</section>

{% if productos_inconsistentes %}
  <section style="margin-bottom:24px;background:rgba(255,196,38,0.14);border:1px solid rgba(255,196,38,0.32);border-radius:18px;padding:18px 20px;color:#7a4d00;font-size:13px;display:flex;flex-direction:column;gap:6px;">
    <strong style="text-transform:uppercase;letter-spacing:0.05em;font-size:12px;">Validacion de datos</strong>
    <span>Detectamos {{ productos_inconsistentes }} productos marcados como sin stock en la fuente, pero con precios vigentes. Revisa estos registros para alinear el flag de stock con los datos reales.</span>
  </section>
{% endif %}

<section style="display:flex;flex-wrap:wrap;gap:20px;margin-bottom:32px;">
  <article style="background:#ffffff;border:1px solid #e3e8f3;padding:20px;border-radius:18px;flex:1;min-width:220px;box-shadow:0 2px 10px rgba(16,20,24,0.06);">
    <h3 style="margin:0 0 6px;font-size:14px;font-weight:700;color:#0b2e68;text-transform:uppercase;letter-spacing:0.05em;">Sugerencias de compra</h3>
    <p style="margin:0;font-size:32px;font-weight:800;color:#0b6cff;">{{ pred_sugerencias }}</p>
    <span style="color:#5b6578;font-size:12px;">Productos priorizados por el modelo predictivo.</span>
  </article>
  <article style="background:#ffffff;border:1px solid #e3e8f3;padding:20px;border-radius:18px;flex:1;min-width:220px;box-shadow:0 2px 10px rgba(16,20,24,0.06);">
    <h3 style="margin:0 0 6px;font-size:14px;font-weight:700;color:#0b2e68;text-transform:uppercase;letter-spacing:0.05em;">Alertas de sobrestock</h3>
    <p style="margin:0;font-size:32px;font-weight:800;color:#d12f2f;">{{ pred_sobrestock }}</p>
    <span style="color:#5b6578;font-size:12px;">Casos donde conviene frenar compras adicionales.</span>
  </article>
  <article style="background:#ffffff;border:1px solid #e3e8f3;padding:20px;border-radius:18px;flex:1;min-width:220px;box-shadow:0 2px 10px rgba(16,20,24,0.06);">
    <h3 style="margin:0 0 6px;font-size:14px;font-weight:700;color:#0b2e68;text-transform:uppercase;letter-spacing:0.05em;">Ultima evaluacion</h3>
    <p style="margin:0;font-size:20px;font-weight:700;color:#0b2e68;">{{ pred_fecha_generacion|date:"d/m/Y H:i" }}</p>
    <span style="color:#5b6578;font-size:12px;">Generado a partir de historial sintetico de 6 meses.</span>
  </article>
</section>

{% if suma_precio or promedio_precio %}
  <section style="display:flex;flex-wrap:wrap;gap:20px;margin-bottom:32px;">
    {% if suma_precio %}
      <div style="flex:1;min-width:260px;background:#ffffff;border-radius:18px;border:1px solid #e3e8f3;padding:20px;">
        <h3 style="margin:0 0 8px;font-size:16px;font-weight:700;color:#0b2e68;">Suma de precios normales</h3>
        <p style="margin:0;font-size:24px;font-weight:800;color:#0b2e68;">${{ suma_precio|floatformat:2 }}</p>
        <span style="color:#5b6578;font-size:12px;">Incluye todos los productos listados.</span>
      </div>
    {% endif %}
    {% if promedio_precio %}
      <div style="flex:1;min-width:260px;background:#ffffff;border-radius:18px;border:1px solid #e3e8f3;padding:20px;">
        <h3 style="margin:0 0 8px;font-size:16px;font-weight:700;color:#0b2e68;">Precio normal promedio</h3>
        <p style="margin:0;font-size:24px;font-weight:800;color:#0b2e68;">${{ promedio_precio|floatformat:2 }}</p>
        <span style="color:#5b6578;font-size:12px;">Calculado a partir de los productos con precio registrado.</span>
      </div>
    {% endif %}
  </section>
{% endif %}

<section style="margin-bottom:32px;background:#ffffff;border-radius:24px;padding:24px 26px;border:1px solid #e3e8f3;box-shadow:0 12px 28px rgba(16,20,24,0.05);">
  <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <div>
      <h3 style="margin:0;font-size:18px;font-weight:700;color:#0b2e68;">Top recomendaciones del modelo</h3>
      <p style="margin:4px 0 0;font-size:12px;color:#5b6578;">Prioriza los productos con mayor probabilidad de requerir reposicion.</p>
    </div>
    <span style="font-size:12px;color:#98a2b3;">Actualizado: {{ pred_fecha_generacion|date:"d/m/Y H:i" }}</span>
  </div>
  <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;min-width:520px;">
      <thead>
        <tr style="background:#f1f4fa;color:#475467;font-size:12px;text-transform:uppercase;letter-spacing:0.05em;">
          <th style="text-align:left;padding:12px 14px;">Producto</th>
          <th style="text-align:left;padding:12px 14px;">Probabilidad</th>
          <th style="text-align:left;padding:12px 14px;">Accion</th>
          <th style="text-align:left;padding:12px 14px;">Motivo</th>
        </tr>
      </thead>
      <tbody>
        {% for item in pred_top %}
          <tr style="border-bottom:1px solid #eef1f7;">
            <td style="padding:12px 14px;">
              <div style="font-weight:700;color:#0b2e68;">{{ item.producto.title }}</div>
              <div style="font-size:12px;color:#667085;">Marca: {{ item.producto.brand|default:"Sin marca" }} | ID: #{{ item.producto.id_producto }}</div>
            </td>
            <td style="padding:12px 14px;">
              <div style="font-weight:700;color:#0b6cff;">{{ item.probabilidad_pct|floatformat:2 }}%</div>
              <div style="font-size:12px;color:#667085;">Confianza del modelo</div>
            </td>
            <td style="padding:12px 14px;">
              <span style="display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;color:{% if item.accion == 'comprar' %}#256c3d{% else %}#8b1a1a{% endif %};background:{% if item.accion == 'comprar' %}rgba(47,176,96,0.16){% else %}rgba(209,47,47,0.16){% endif %};">
                {% if item.accion == 'comprar' %}Comprar{% else %}No comprar{% endif %}
              </span>
              <div style="font-size:12px;color:#667085;margin-top:6px;">{{ item.mensaje }}</div>
            </td>
            <td style="padding:12px 14px;font-size:12px;color:#475467;">{{ item.motivo }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" style="padding:16px 14px;text-align:center;font-size:13px;color:#98a2b3;font-weight:600;">No hay predicciones suficientes para mostrar un resumen.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section style="margin-bottom:20px;background:#ffffff;border-radius:24px;padding:28px;border:1px solid #e3e8f3;">
  <h3 style="margin:0 0 16px;font-size:18px;font-weight:700;color:#0b2e68;">Distribucion del inventario</h3>
  <div style="width:min(360px,100%);height:360px;margin:0 auto;">
    <canvas id="chartProductos" width="360" height="360"></canvas>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const canvas = document.getElementById('chartProductos');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Con stock', 'Sin stock', 'En oferta'],
      datasets: [{
        label: 'Distribucion de productos',
        data: [
          {{ productos_con_stock|default:0 }},
          {{ productos_sin_stock|default:0 }},
          {{ productos_en_oferta|default:0 }}
        ],
        backgroundColor: ['#1f9d55', '#dc3545', '#f0ad4e'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      },
      cutout: '60%'
    }
  });
});
</script>
{% endblock %}
