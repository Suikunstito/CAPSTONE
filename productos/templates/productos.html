{% extends "base.html" %}
{% block title %}Productos{% endblock %}

{% block content %}
<style>
  .inventory-header {
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-bottom:24px;
  }

  .inventory-header__info h2 {
    margin:0;
    font-size:30px;
    font-weight:800;
    color:var(--primary);
  }

  .inventory-header__info p {
    margin:0;
    color:var(--muted);
    font-size:14px;
  }

  .inventory-header__note {
    margin-top:4px;
    background:rgba(11,46,104,0.08);
    border-left:4px solid var(--primary);
    padding:10px 14px;
    border-radius:12px;
    font-size:13px;
    color:#1d3360;
  }

  .inventory-summary {
    display:grid;
    gap:16px;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    margin-bottom:28px;
  }

  .summary-card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px 18px;
    box-shadow:0 2px 8px rgba(16,20,24,0.04);
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .summary-card__label {
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    font-weight:700;
  }

  .summary-card__value {
    font-size:28px;
    font-weight:800;
    color:var(--primary);
    line-height:1;
  }

  .summary-card__hint {
    font-size:12px;
    color:var(--muted);
  }

  .inventory-toolbar {
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-end;
    justify-content:space-between;
    margin-bottom:18px;
  }

  .toolbar__search {
    flex:1;
    min-width:240px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .toolbar__search label {
    font-size:13px;
    font-weight:600;
    color:var(--muted);
  }

  .search-box {
    display:flex;
    align-items:center;
    gap:8px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:8px 12px;
    box-shadow:0 1px 4px rgba(16,20,24,0.05);
  }

  .search-box input {
    flex:1;
    border:none;
    outline:none;
    font-size:14px;
    background:transparent;
    color:var(--text);
  }

  .toolbar__right {
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
  }

  .toolbar__filters {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .filter-pill {
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 12px;
    font-size:13px;
    color:var(--muted);
    cursor:pointer;
    transition:border-color 0.18s ease, box-shadow 0.18s ease;
  }

  .filter-pill:hover {
    border-color:#d7dde7;
    box-shadow:0 8px 18px rgba(16,20,24,0.08);
  }

  .filter-pill input {
    accent-color:var(--primary);
  }

  .toolbar__legend {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
    color:var(--muted);
    font-size:12px;
  }

  .legend-item {
    display:flex;
    align-items:center;
    gap:6px;
  }

  .legend-dot {
    width:10px;
    height:10px;
    border-radius:50%;
    display:inline-flex;
  }

  .legend-dot--available { background:#3ac06b; }
  .legend-dot--warn { background:#d12f2f; }

  .inventory-table-container {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:24px;
    overflow:hidden;
    box-shadow:0 12px 30px rgba(16,20,24,0.06);
  }

  .inventory-table {
    width:100%;
    border-collapse:collapse;
    min-width:760px;
  }

  .inventory-table thead th {
    background:#f1f4fa;
    color:#475467;
    font-size:12px;
    font-weight:700;
    letter-spacing:0.05em;
    text-transform:uppercase;
    padding:14px 18px;
    border-bottom:1px solid var(--border);
    text-align:left;
  }

  .inventory-table tbody td {
    padding:16px 18px;
    font-size:14px;
    border-bottom:1px solid #f0f2f7;
    color:#2f3847;
    vertical-align:top;
  }

  .inventory-table tbody tr:hover {
    background:rgba(11,46,104,0.04);
  }

  .inventory-table tbody tr:last-child td {
    border-bottom:none;
  }

  .cell-id {
    font-weight:700;
    color:var(--primary);
    font-size:12px;
    letter-spacing:0.08em;
    text-transform:uppercase;
  }

  .product-primary {
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .product-title {
    font-weight:700;
    font-size:15px;
  }

  .product-attrs {
    font-size:12px;
    color:var(--muted);
    background:rgba(16,20,24,0.04);
    padding:4px 8px;
    border-radius:8px;
    align-self:flex-start;
  }

  .product-updated {
    font-size:11px;
    color:#98a2b3;
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .product-categories {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }

  .category-pill {
    background:rgba(11,108,255,0.12);
    color:#0b5bd9;
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }

  .category-pill--sub {
    background:rgba(11,46,104,0.1);
    color:var(--primary);
  }

  .muted {
    color:#98a2b3;
    font-style:italic;
  }

  .price-main {
    font-weight:800;
    color:#101828;
    display:block;
  }

  .price-meta {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    font-size:12px;
    color:#475467;
    margin-top:6px;
  }

  .price-saving {
    font-weight:700;
    color:#0b5bd9;
  }

  .status-pill {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:110px;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .status-pill--ok {
    background:rgba(58,192,107,0.16);
    color:#256c3d;
  }

  .status-pill--warn {
    background:rgba(209,47,47,0.14);
    color:#8b1a1a;
  }

  .status-pill--info {
    background:rgba(11,108,255,0.14);
    color:#0b5bd9;
  }

  .status-pill--neutral {
    background:rgba(102,112,133,0.16);
    color:#475467;
  }

  .status-note {
    display:inline-block;
    margin-top:6px;
    padding:4px 8px;
    border-radius:8px;
    font-size:11px;
    color:#a15c00;
    background:rgba(244,180,0,0.18);
    text-transform:uppercase;
    letter-spacing:0.05em;
    font-weight:700;
  }

  .table-actions {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .table-actions__link {
    font-weight:700;
    font-size:13px;
    color:var(--primary);
    text-decoration:none;
    padding:4px 0;
    position:relative;
  }

  .table-actions__link::after {
    content:'';
    position:absolute;
    left:0;
    right:0;
    bottom:-2px;
    height:2px;
    background:currentColor;
    transform:scaleX(0);
    transition:transform 0.18s ease;
    transform-origin:left;
  }

  .table-actions__link:hover::after {
    transform:scaleX(1);
  }

  .table-actions__link--danger {
    color:#d12f2f;
  }

  .table-empty {
    text-align:center;
    padding:40px 18px;
    color:#475467;
    font-size:14px;
    font-weight:600;
  }

  @media (max-width:900px) {
    .inventory-table { min-width:100%; }
    .inventory-header__info h2 { font-size:26px; }
    .toolbar__right { align-items:flex-start; }
  }

  @media (max-width:640px) {
    .inventory-toolbar {
      flex-direction:column;
      align-items:stretch;
    }
    .toolbar__right {
      width:100%;
      align-items:flex-start;
    }
  }
</style>

<section class="inventory-header">
  <div class="inventory-header__info">
    <h2>Inventario de productos</h2>
    <p>
      {% if is_admin %}
        Visualiza el estado del catalogo y utiliza las acciones disponibles para mantener los datos actualizados.
      {% else %}
        Revisa el inventario disponible y filtra los resultados para encontrar productos especificos.
      {% endif %}
    </p>
    {% if is_admin %}
      <div class="inventory-header__note">
        La creacion de nuevos productos esta disponible desde el modulo de Dashboard o cualquier acceso directo de administracion. <br />
        Detectamos {{ productos_inconsistentes }} registros marcados sin stock en el origen pero con precios activos; conviene revisarlos antes de tomar decisiones de compra.
      </div>
    {% endif %}
  </div>
</section>

<section class="inventory-summary">
  <article class="summary-card">
    <span class="summary-card__label">Total de productos</span>
    <span class="summary-card__value">{{ total_productos }}</span>
    <span class="summary-card__hint">Registros en el catalogo</span>
  </article>
  <article class="summary-card">
    <span class="summary-card__label">Disponibles</span>
    <span class="summary-card__value">{{ productos_disponibles }}</span>
    <span class="summary-card__hint">Con precios vigentes en catalogo</span>
  </article>
  <article class="summary-card">
    <span class="summary-card__label">Sin stock</span>
    <span class="summary-card__value">{{ productos_sin_stock }}</span>
    <span class="summary-card__hint">Sin informacion de precio o agotados</span>
  </article>
  <article class="summary-card">
    <span class="summary-card__label">En oferta</span>
    <span class="summary-card__value">{{ productos_en_oferta }}</span>
    <span class="summary-card__hint">Con descuentos activos</span>
  </article>
  <article class="summary-card">
    <span class="summary-card__label">Marcas registradas</span>
    <span class="summary-card__value">{{ marcas_registradas }}</span>
    <span class="summary-card__hint">Diversidad de catalogo</span>
  </article>
  <article class="summary-card">
    <span class="summary-card__label">Revisar manualmente</span>
    <span class="summary-card__value">{{ productos_inconsistentes }}</span>
    <span class="summary-card__hint">Marcados sin stock pero con precio activo</span>
  </article>
</section>

<section class="inventory-toolbar">
  <div class="toolbar__search">
    <label for="inventorySearch">Buscar producto</label>
    <div class="search-box">
      <input type="search" id="inventorySearch" placeholder="Buscar por titulo, marca o categoria..." autocomplete="off" />
    </div>
  </div>
  <div class="toolbar__right">
    <div class="toolbar__filters">
      <label class="filter-pill">
        <input type="checkbox" id="filterDisponibles" />
        <span>Ocultar sin stock</span>
      </label>
      <label class="filter-pill">
        <input type="checkbox" id="filterOfertas" />
        <span>Solo ofertas</span>
      </label>
    </div>
    <div class="toolbar__legend">
      <span class="legend-item">
        <span class="legend-dot legend-dot--available"></span> Disponible
      </span>
      <span class="legend-item">
        <span class="legend-dot legend-dot--warn"></span> Sin stock
      </span>
    </div>
  </div>
</section>

<div class="inventory-table-container">
  <div style="overflow-x:auto;">
    <table class="inventory-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Producto</th>
          <th>Marca</th>
          <th>Categoria</th>
          <th>Precios</th>
          <th>Disponibilidad</th>
          <th>Oferta</th>
          {% if is_admin %}
            <th>Acciones</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
          <tr
            data-product-row
            data-search="{{ p.title|default:''|lower }} {{ p.brand|default:''|lower }} {{ p.categoria1|default:''|lower }} {{ p.categoria2|default:''|lower }}"
            data-stock="{% if p.disponible %}available{% else %}no-stock{% endif %}"
            data-oferta="{% if p.oferta_activa %}true{% else %}false{% endif %}"
          >
            <td class="cell-id">#{{ p.id_producto }}</td>
            <td>
              <div class="product-primary">
                <span class="product-title">{{ p.title }}</span>
                {% if p.atributos %}
                  <span class="product-attrs">{{ p.atributos }}</span>
                {% endif %}
                {% if p.datetime %}
                  <span class="product-updated">Actualizado: {{ p.datetime }}</span>
                {% endif %}
              </div>
            </td>
            <td>{{ p.brand|default:"Sin marca" }}</td>
            <td>
              <div class="product-categories">
                {% if p.categoria1 %}
                  <span class="category-pill">{{ p.categoria1 }}</span>
                {% endif %}
                {% if p.categoria2 and p.categoria2 != p.categoria1 %}
                  <span class="category-pill category-pill--sub">{{ p.categoria2 }}</span>
                {% endif %}
                {% if not p.categoria1 and not p.categoria2 %}
                  <span class="muted">Sin categoria</span>
                {% endif %}
              </div>
            </td>
            <td>
              {% if p.normal_price and p.normal_price > 0 %}
                <span class="price-main">${{ p.normal_price }}</span>
              {% elif p.low_price and p.low_price > 0 %}
                <span class="price-main">${{ p.low_price }}</span>
              {% else %}
                <span class="muted">Sin precio</span>
              {% endif %}
              <div class="price-meta">
                {% if p.low_price and p.low_price > 0 %}
                  {% if not p.normal_price or p.low_price != p.normal_price %}
                    <span>Min: ${{ p.low_price }}</span>
                  {% endif %}
                {% endif %}
                {% if p.high_price and p.high_price > 0 %}
                  <span>Max: ${{ p.high_price }}</span>
                {% endif %}
                {% if p.ahorro_percent and p.ahorro_percent > 0 %}
                  <span class="price-saving">Ahorro {{ p.ahorro_percent }}%</span>
                {% elif p.ahorro and p.ahorro > 0 %}
                  <span class="price-saving">Ahorro ${{ p.ahorro }}</span>
                {% endif %}
              </div>
            </td>
            <td>
              <span class="status-pill {% if p.disponible %}status-pill--ok{% else %}status-pill--warn{% endif %}">
                {% if p.disponible %}
                  Disponible
                {% else %}
                  Sin stock
                {% endif %}
              </span>
              {% if p.stock_inconsistente %}
                <span class="status-note">Origen marca sin stock</span>
              {% endif %}
            </td>
            <td>
              {% if p.oferta_activa %}
                <span class="status-pill status-pill--info">En oferta</span>
              {% else %}
                <span class="status-pill status-pill--neutral">Precio regular</span>
              {% endif %}
            </td>
            {% if is_admin %}
              <td>
                <div class="table-actions">
                  <a href="{% url 'editar_producto' p.id_producto %}" class="table-actions__link">Editar</a>
                  <a href="{% url 'eliminar_producto' p.id_producto %}" class="table-actions__link table-actions__link--danger">Eliminar</a>
                </div>
              </td>
            {% endif %}
          </tr>
        {% empty %}
          <tr>
            <td colspan="{% if is_admin %}8{% else %}7{% endif %}" class="table-empty">
              Todavia no hay productos registrados.
            </td>
          </tr>
        {% endfor %}
        <tr data-empty-state style="display:none;">
          <td colspan="{% if is_admin %}8{% else %}7{% endif %}" class="table-empty">
            No se encontraron productos con los filtros aplicados.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const searchInput = document.getElementById('inventorySearch');
    const filterOfertas = document.getElementById('filterOfertas');
    const filterDisponibles = document.getElementById('filterDisponibles');
    const rows = Array.from(document.querySelectorAll('[data-product-row]'));
    const emptyState = document.querySelector('[data-empty-state]');

    if (!searchInput || !rows.length) {
      return;
    }

    const applyFilters = () => {
      const term = searchInput.value.trim().toLowerCase();
      const onlyOffers = Boolean(filterOfertas && filterOfertas.checked);
      const hideNoStock = Boolean(filterDisponibles && filterDisponibles.checked);
      let visibleRows = 0;

      rows.forEach((row) => {
        const matchesTerm = !term || (row.dataset.search || '').includes(term);
        const matchesOffer = !onlyOffers || row.dataset.oferta === 'true';
        const matchesStock = !hideNoStock || row.dataset.stock === 'available';
        const isVisible = matchesTerm && matchesOffer && matchesStock;

        row.style.display = isVisible ? '' : 'none';
        if (isVisible) {
          visibleRows += 1;
        }
      });

      if (emptyState) {
        emptyState.style.display = visibleRows ? 'none' : '';
      }
    };

    [searchInput, filterOfertas, filterDisponibles].forEach((control) => {
      if (!control) {
        return;
      }
      const eventName = control.type === 'checkbox' ? 'change' : 'input';
      control.addEventListener(eventName, applyFilters);
    });

    applyFilters();
  }());
</script>
{% endblock %}
