{% extends "base.html" %}
{% block title %}Prediccion de productos{% endblock %}

{% block content %}
<style>
  .pred-header {
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-bottom:28px;
  }

  .pred-header h2 {
    margin:0;
    font-size:30px;
    font-weight:800;
    color:var(--primary);
  }

  .pred-header p {
    margin:0;
    color:var(--muted);
    font-size:14px;
  }

  .pred-header__badge {
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:rgba(11,108,255,0.1);
    color:#0b5bd9;
    padding:8px 12px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .pred-header__note {
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px 16px;
    font-size:12px;
    color:#475467;
  }

  .pred-summary {
    display:grid;
    gap:16px;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    margin-bottom:32px;
  }

  .pred-card {
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px 20px;
    box-shadow:0 2px 8px rgba(16,20,24,0.04);
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .pred-card__title {
    margin:0;
    font-size:13px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
  }

  .pred-card__value {
    margin:0;
    font-size:32px;
    font-weight:800;
    color:var(--primary);
  }

  .pred-card__hint {
    margin:0;
    font-size:12px;
    color:#667085;
  }

  .pred-toolbar {
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-end;
    justify-content:space-between;
    margin-bottom:20px;
  }

  .pred-search {
    flex:1;
    min-width:240px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .pred-search label {
    font-size:13px;
    color:var(--muted);
    font-weight:600;
  }

  .pred-search input {
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    transition:border-color 0.18s ease, box-shadow 0.18s ease;
  }

  .pred-search input:focus {
    border-color:#94b5ff;
    box-shadow:0 0 0 3px rgba(11,108,255,0.15);
  }

  .pred-filters {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }

  .pred-filter {
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:999px;
    padding:8px 14px;
    font-size:13px;
    color:#475467;
    cursor:pointer;
    transition:border-color 0.18s ease, box-shadow 0.18s ease;
  }

  .pred-filter input {
    accent-color:var(--primary);
  }

  .pred-filter:hover {
    border-color:#ced4e2;
    box-shadow:0 6px 16px rgba(16,20,24,0.08);
  }

  .pred-table-wrapper {
    background:#ffffff;
    border-radius:24px;
    border:1px solid var(--border);
    overflow:hidden;
    box-shadow:0 12px 28px rgba(16,20,24,0.05);
  }

  .pred-table {
    width:100%;
    border-collapse:collapse;
    min-width:860px;
  }

  .pred-table thead th {
    background:#f1f4fa;
    padding:14px 16px;
    font-size:12px;
    font-weight:700;
    letter-spacing:0.05em;
    text-transform:uppercase;
    color:#475467;
    text-align:left;
    border-bottom:1px solid var(--border);
  }

  .pred-table tbody td {
    padding:16px 16px;
    border-bottom:1px solid #eef1f7;
    vertical-align:top;
    font-size:14px;
    color:#1d2939;
  }

  .pred-table tbody tr:hover {
    background:rgba(11,108,255,0.04);
  }

  .pred-product {
    font-weight:700;
    margin-bottom:6px;
  }

  .pred-brand {
    font-size:12px;
    color:#667085;
  }

  .history-bars {
    display:flex;
    gap:6px;
    align-items:flex-end;
    margin-top:10px;
  }

  .history-bar {
    width:14px;
    background:rgba(11,108,255,0.2);
    border-radius:6px 6px 0 0;
    position:relative;
  }

  .history-bar::after {
    content:attr(data-label);
    position:absolute;
    bottom:-18px;
    left:50%;
    transform:translateX(-50%);
    font-size:10px;
    color:#98a2b3;
    white-space:nowrap;
  }

  .history-bar::before {
    content:attr(data-value) 'u';
    position:absolute;
    top:-18px;
    left:50%;
    transform:translateX(-50%);
    font-size:10px;
    color:#475467;
    opacity:0;
    transition:opacity 0.18s ease;
  }

  .history-bar:hover::before {
    opacity:1;
  }

  .pred-metrics {
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:12px;
    color:#475467;
  }

  .pred-metric-strong {
    font-size:13px;
    font-weight:700;
    color:#0b2e68;
  }

  .pred-prob {
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .prob-bar {
    height:6px;
    border-radius:999px;
    background:rgba(11,108,255,0.2);
    overflow:hidden;
  }

  .prob-bar__fill {
    height:100%;
    background:#0b6cff;
  }

  .pred-badge {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .pred-badge--buy {
    background:rgba(47,176,96,0.16);
    color:#256c3d;
  }

  .pred-badge--hold {
    background:rgba(209,47,47,0.16);
    color:#8b1a1a;
  }

  .pred-empty {
    text-align:center;
    padding:32px 16px;
    color:#98a2b3;
    font-size:14px;
    font-weight:600;
  }

  .pred-footnote {
    margin-top:20px;
    font-size:12px;
    color:#98a2b3;
    text-align:right;
  }

  @media (max-width:900px) {
    .pred-toolbar {
      flex-direction:column;
      align-items:stretch;
    }
    .pred-filters {
      justify-content:flex-start;
    }
  }
</style>

<section class="pred-header">
  <div class="pred-header__badge">Modelo de aprendizaje automatico</div>
  <h2>Prediccion de productos</h2>
  <p>Revisa las recomendaciones generadas a partir de un historial sintetico de compras para identificar donde comprar y donde hacer una pausa.</p>
  <div class="pred-header__note">
    Datos generados el {{ fecha_generacion|date:"d/m/Y H:i" }}. Esta simulacion se apoya en la base de productos de Santa Isabel y asume un comportamiento de ventas de los ultimos seis meses.
  </div>
</section>

<section class="pred-summary">
  <article class="pred-card">
    <h3 class="pred-card__title">Productos evaluados</h3>
    <p class="pred-card__value">{{ predicciones|length }}</p>
    <p class="pred-card__hint">Total de items analizados por el modelo.</p>
  </article>
  <article class="pred-card">
    <h3 class="pred-card__title">Sugerencias de compra</h3>
    <p class="pred-card__value">{{ sugerencias_count }}</p>
    <p class="pred-card__hint">Productos con probabilidad alta de requerir reposicion.</p>
  </article>
  <article class="pred-card">
    <h3 class="pred-card__title">Alertas de sobrestock</h3>
    <p class="pred-card__value">{{ sobrestock_count }}</p>
    <p class="pred-card__hint">Casos donde el modelo recomienda pausar compras.</p>
  </article>
</section>

<section class="pred-toolbar">
  <div class="pred-search">
    <label for="predSearch">Buscar producto</label>
    <input type="search" id="predSearch" placeholder="Buscar por titulo o marca..." autocomplete="off" />
  </div>
  <div class="pred-filters">
    <label class="pred-filter">
      <input type="checkbox" id="filterSoloComprar" />
      <span>Solo sugerencias de compra</span>
    </label>
    <label class="pred-filter">
      <input type="checkbox" id="filterSoloSobrestock" />
      <span>Solo alertas de sobrestock</span>
    </label>
  </div>
</section>

<div class="pred-table-wrapper">
  <div style="overflow-x:auto;">
    <table class="pred-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Historial de compras</th>
          <th>Demanda</th>
          <th>Modelo</th>
          <th>Accion sugerida</th>
        </tr>
      </thead>
      <tbody>
        {% for item in predicciones %}
          <tr
            data-pred-row
            data-accion="{{ item.accion }}"
            data-search="{{ item.producto.title|default:''|lower }} {{ item.producto.brand|default:''|lower }}"
          >
            <td>
              <div class="pred-product">{{ item.producto.title }}</div>
              <div class="pred-brand">
                Marca: {{ item.producto.brand|default:"Sin marca" }} |
                ID: #{{ item.producto.id_producto }}
              </div>
            </td>
            <td>
              {% if item.historial %}
                {% with max_val=item.max_historial|default:1 %}
                  <div class="history-bars">
                    {% for registro in item.historial %}
                      {% widthratio registro.quantity max_val 100 as bar_height %}
                      <div
                        class="history-bar"
                        style="height:{{ bar_height }}%;"
                        data-label="{{ registro.period_label }}"
                        data-value="{{ registro.quantity }}"
                      ></div>
                    {% endfor %}
                  </div>
                {% endwith %}
              {% else %}
                <span class="pred-brand">Sin datos historicos</span>
              {% endif %}
            </td>
            <td>
              <div class="pred-metrics">
                <span class="pred-metric-strong">Promedio mensual: {{ item.promedio_mensual|floatformat:2 }} u.</span>
                <span>Ultimo mes: {{ item.ultima_cantidad }} u.</span>
                <span>Tendencia 6m: {{ item.tendencia|floatformat:2 }} u.</span>
                <span>Volatilidad: {{ item.volatilidad|floatformat:2 }} u.</span>
              </div>
            </td>
            <td>
              <div class="pred-prob">
                <div>Probabilidad de compra: {{ item.probabilidad_pct|floatformat:2 }}%</div>
                <div class="prob-bar">
                  <div class="prob-bar__fill" style="width:{{ item.probabilidad_pct }}%;"></div>
                </div>
                <div style="font-size:12px;color:#667085;">{{ item.mensaje }}</div>
                <div style="font-size:12px;color:#475467;">
                  Precio referencia:
                  {% if item.precio_referencia %}
                    ${{ item.precio_referencia|floatformat:2 }}
                  {% else %}
                    Sin precio disponible
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <span class="pred-badge {% if item.accion == 'comprar' %}pred-badge--buy{% else %}pred-badge--hold{% endif %}">
                  {% if item.accion == 'comprar' %}Comprar{% else %}No comprar{% endif %}
                </span>
                <span style="font-size:12px;color:#475467;">{{ item.motivo }}</span>
                {% if item.accion == 'comprar' %}
                  <span style="font-size:12px;color:#0b2e68;font-weight:600;">
                    Cantidad sugerida: {{ item.cantidad_sugerida }} u.
                  </span>
                {% else %}
                  <span style="font-size:12px;color:#5b6578;">
                    Stock estimado: {{ item.stock_estimado }} u.
                  </span>
                {% endif %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="pred-empty">No hay predicciones disponibles por el momento.</td>
          </tr>
        {% endfor %}
        <tr data-empty-row style="display:none;">
          <td colspan="5" class="pred-empty">No se encontraron predicciones con los filtros aplicados.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<p class="pred-footnote">
  Este ejercicio utiliza un modelo ligero de regresion logistica y un historial sintetico para demostrar capacidades de analitica predictiva.
</p>

<script>
  (function () {
    const searchInput = document.getElementById('predSearch');
    const filterComprar = document.getElementById('filterSoloComprar');
    const filterSobrestock = document.getElementById('filterSoloSobrestock');
    const rows = Array.from(document.querySelectorAll('[data-pred-row]'));
    const emptyRow = document.querySelector('[data-empty-row]');

    if (!rows.length) {
      return;
    }

    const applyFilters = () => {
      const term = (searchInput?.value || '').trim().toLowerCase();
      const onlyComprar = filterComprar?.checked;
      const onlySobrestock = filterSobrestock?.checked;
      let visible = 0;

      rows.forEach((row) => {
        const accion = row.dataset.accion;
        const matchesTerm = !term || (row.dataset.search || '').includes(term);
        const matchesComprar = !onlyComprar || accion === 'comprar';
        const matchesSobrestock = !onlySobrestock || accion === 'no_comprar';
        const shouldShow = matchesTerm && matchesComprar && matchesSobrestock;
        row.style.display = shouldShow ? '' : 'none';
        if (shouldShow) {
          visible += 1;
        }
      });

      if (emptyRow) {
        emptyRow.style.display = visible ? 'none' : '';
      }
    };

    [searchInput, filterComprar, filterSobrestock].forEach((control) => {
      if (!control) return;
      const eventName = control.type === 'checkbox' ? 'change' : 'input';
      control.addEventListener(eventName, applyFilters);
    });

    applyFilters();
  })();
</script>
{% endblock %}
